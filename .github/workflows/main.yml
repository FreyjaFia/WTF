name: Build and Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  versioning:
    name: Resolve Version
    runs-on: ubuntu-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
      app_version_code: ${{ steps.version.outputs.app_version_code }}
      tag_name: ${{ steps.version.outputs.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Resolve app version and validate tag
        id: version
        run: |
          APP_VERSION=$(node -p "require('./src/wtf-pos/package.json').version")
          if [[ ! "$APP_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "package.json version must use semver MAJOR.MINOR.PATCH"
            exit 1
          fi

          IFS='.' read -r MAJOR MINOR PATCH <<< "$APP_VERSION"
          APP_VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          TAG_NAME="v${APP_VERSION}"

          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            REF_TAG="${GITHUB_REF#refs/tags/}"
            if [[ "$REF_TAG" != "$TAG_NAME" ]]; then
              echo "Tag (${REF_TAG}) does not match package.json version (${TAG_NAME})"
              exit 1
            fi
          fi

          echo "app_version=$APP_VERSION" >> "$GITHUB_OUTPUT"
          echo "app_version_code=$APP_VERSION_CODE" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: versioning
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore and Build API
        run: dotnet build src/WTF.Api/WTF.Api.csproj --configuration Release

      - name: Publish API
        if: github.event_name != 'pull_request'
        run: dotnet publish src/WTF.Api/WTF.Api.csproj -c Release -o ./publish

      - name: Upload API Artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: api-drop
          path: ./publish

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: versioning
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: src/wtf-pos/package-lock.json

      - name: Install dependencies
        working-directory: src/wtf-pos
        run: npm ci

      - name: Generate version.ts
        working-directory: src/wtf-pos
        run: printf "export const appVersion = '%s';\n" "${{ needs.versioning.outputs.app_version }}" > src/environments/version.ts

      - name: Build frontend
        working-directory: src/wtf-pos
        run: npm run build

      - name: Upload Frontend Artifact
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-drop
          path: src/wtf-pos/dist/wtf-pos/browser/

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: versioning
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          cache-dependency-path: src/wtf-pos/package-lock.json

      - name: Install dependencies
        working-directory: src/wtf-pos
        run: npm ci

      - name: Generate version.ts
        working-directory: src/wtf-pos
        run: printf "export const appVersion = '%s';\n" "${{ needs.versioning.outputs.app_version }}" > src/environments/version.ts

      - name: Build Angular for Android
        working-directory: src/wtf-pos
        run: npm run build:android

      - name: Sync Capacitor
        working-directory: src/wtf-pos
        run: npx cap sync android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('src/wtf-pos/android/**/*.gradle*', 'src/wtf-pos/android/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Decode Keystore
        run: |
          mkdir -p src/wtf-pos/android/keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > src/wtf-pos/android/keystore/wtf-pos-release.keystore

      - name: Build APK
        working-directory: src/wtf-pos/android
        env:
          APP_VERSION_NAME: ${{ needs.versioning.outputs.app_version }}
          APP_VERSION_CODE: ${{ needs.versioning.outputs.app_version_code }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: chmod +x ./gradlew && ./gradlew assembleRelease --no-daemon

      - name: Rename APK with version
        run: |
          VERSION="${{ needs.versioning.outputs.app_version }}"
          cp src/wtf-pos/android/app/build/outputs/apk/release/app-release.apk "src/wtf-pos/android/app/build/outputs/apk/release/wtf-pos-v${VERSION}.apk"

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: src/wtf-pos/android/app/build/outputs/apk/release/wtf-pos-v${{ needs.versioning.outputs.app_version }}.apk

  deploy-sql:
    name: Deploy SQL Scripts
    runs-on: ubuntu-latest
    needs: versioning
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Apply SQL scripts in order
        env:
          SQL_SERVER: ${{ secrets.SQL_SERVER }}
          SQL_DATABASE: ${{ secrets.SQL_DATABASE }}
          SQL_USERNAME: ${{ secrets.SQL_USERNAME }}
          SQL_PASSWORD: ${{ secrets.SQL_PASSWORD }}
        run: |
          if [ -z "$SQL_SERVER" ] || [ -z "$SQL_DATABASE" ] || [ -z "$SQL_USERNAME" ] || [ -z "$SQL_PASSWORD" ]; then
            echo "Missing SQL deployment secrets (SQL_SERVER, SQL_DATABASE, SQL_USERNAME, SQL_PASSWORD)."
            exit 1
          fi

          mapfile -t scripts < <(find tools/sql -maxdepth 1 -type f -name '*.sql' | sort)
          if [ "${#scripts[@]}" -eq 0 ]; then
            echo "No SQL scripts found in tools/sql."
            exit 0
          fi

          for script in "${scripts[@]}"; do
            script_name="$(basename "$script")"
            script_name_sql="$(printf "%s" "$script_name" | sed "s/'/''/g")"

            applied_count="$(docker run --rm \
              -v "$PWD:/workspace" \
              mcr.microsoft.com/mssql-tools \
              /opt/mssql-tools/bin/sqlcmd \
              -S "$SQL_SERVER" \
              -d "$SQL_DATABASE" \
              -U "$SQL_USERNAME" \
              -P "$SQL_PASSWORD" \
              -C \
              -h -1 \
              -W \
              -Q "SET NOCOUNT ON; SELECT COUNT(1) FROM dbo.SchemaScriptHistory WHERE ScriptName = N'$script_name_sql';" \
              | tr -d '[:space:]')"

            if [ "$applied_count" != "0" ]; then
              echo "Skipping ${script_name} (already applied)."
              continue
            fi

            echo "Applying ${script_name}"
            docker run --rm \
              -v "$PWD:/workspace" \
              mcr.microsoft.com/mssql-tools \
              /opt/mssql-tools/bin/sqlcmd \
              -S "$SQL_SERVER" \
              -d "$SQL_DATABASE" \
              -U "$SQL_USERNAME" \
              -P "$SQL_PASSWORD" \
              -C \
              -b \
              -i "/workspace/${script}"

            docker run --rm \
              -v "$PWD:/workspace" \
              mcr.microsoft.com/mssql-tools \
              /opt/mssql-tools/bin/sqlcmd \
              -S "$SQL_SERVER" \
              -d "$SQL_DATABASE" \
              -U "$SQL_USERNAME" \
              -P "$SQL_PASSWORD" \
              -C \
              -b \
              -Q "INSERT INTO dbo.SchemaScriptHistory (ScriptName) VALUES (N'$script_name_sql');"
          done

  deploy:
    name: Deploy to MonsterASP.NET
    runs-on: ubuntu-latest
    needs: [build-api, build-frontend, build-android, deploy-sql]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout app_offline.htm
        uses: actions/checkout@v4
        with:
          sparse-checkout: app_offline.htm
          sparse-checkout-cone-mode: false

      - name: Take app offline
        run: |
          curl -T ./app_offline.htm "ftp://${{ secrets.MONSTERASP_FTP_SERVER }}/wwwroot/app_offline.htm" --user "${{ secrets.MONSTERASP_FTP_USERNAME }}:${{ secrets.MONSTERASP_FTP_PASSWORD }}"
          sleep 10

      - name: Download API Artifact
        uses: actions/download-artifact@v4
        with:
          name: api-drop
          path: ./deploy

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-drop
          path: ./deploy/wwwroot

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.MONSTERASP_FTP_SERVER }}
          username: ${{ secrets.MONSTERASP_FTP_USERNAME }}
          password: ${{ secrets.MONSTERASP_FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: /wwwroot/

      - name: Remove app_offline.htm
        run: |
          curl "ftp://${{ secrets.MONSTERASP_FTP_SERVER }}/wwwroot/" --user "${{ secrets.MONSTERASP_FTP_USERNAME }}:${{ secrets.MONSTERASP_FTP_PASSWORD }}" -Q "DELE /wwwroot/app_offline.htm"

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-api, build-frontend, build-android, versioning]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: ./release-assets

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: ./release-assets/*.apk
          fail_on_unmatched_files: true
          generate_release_notes: true
