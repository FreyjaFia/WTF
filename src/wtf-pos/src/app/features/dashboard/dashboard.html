<div class="flex h-full flex-col">
  <!-- Header -->
  <div class="mb-4 flex shrink-0 flex-col gap-3 sm:mb-6 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex flex-col gap-1">
      <h1
        class="text-xl font-extrabold tracking-tight text-gray-900 sm:text-2xl"
        style="font-family: 'Plus Jakarta Sans', sans-serif"
      >
        {{ greeting }}
      </h1>
      <p class="text-xs text-gray-500 sm:text-sm">Real-time sales, orders, and performance insights</p>
    </div>
    <div class="flex items-center justify-end gap-1.5">
      <app-date-range-picker (rangeChanged)="onDateRangeChanged($event)" />
      @if (!isAndroidPlatform) {
        <button
          class="tooltip tooltip-bottom pointer-events-auto z-30 cursor-pointer rounded-lg p-2 transition-all hover:bg-gray-100 active:scale-95"
          [class.opacity-70]="isLoading() || isRefreshing()"
          type="button"
          (click)="refreshDashboard()"
          [disabled]="isLoading() || isRefreshing()"
          aria-label="Refresh dashboard"
          data-tip="Refresh"
        >
          @if (isLoading() || isRefreshing()) {
            <app-icon
              name="icon-refresh"
              [class]="'h-5 w-5 animate-spin text-gray-600'"
              [fill]="'currentColor'"
            />
          } @else {
            <app-icon
              name="icon-refresh"
              [class]="'h-5 w-5 text-gray-600 transition-colors hover:text-gray-900'"
              [fill]="'currentColor'"
            />
          }
        </button>
      }
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="flex justify-center py-8">
      <span class="loading loading-spinner loading-lg"></span>
    </div>
  }

  @if (!isLoading()) {
    <app-pull-to-refresh [refreshing]="isRefreshing()" (refreshTriggered)="refreshDashboard()">
      <!-- Error State -->
      @if (errorMessage()) {
        <div class="rounded-2xl bg-white p-8 text-center shadow-md ring-1 ring-black/5">
          <app-icon name="icon-error" [class]="'mx-auto mb-3 h-12 w-12 text-gray-400'" />
          <p class="text-lg font-semibold text-gray-700">{{ errorMessage() }}</p>
          <p class="text-sm text-gray-500">Pull down to try again</p>
        </div>
      }

      @if (!errorMessage() && dashboard(); as d) {
        <div class="space-y-2 pb-4 md:space-y-3">
          <!-- 1. Hero Section - KPI Cards -->
          <div class="grid grid-cols-2 gap-2 sm:grid-cols-4 md:gap-3">
            <!-- Total Sales -->
            <div class="flex flex-col rounded-2xl bg-white p-4 shadow-md ring-1 ring-black/5">
              <div class="flex items-center gap-2">
                <app-icon name="icon-trending-up" [class]="'h-4 w-4 text-emerald-600'" />
                <p class="text-xs font-semibold tracking-wider text-gray-500 uppercase">
                  Total Sales
                </p>
              </div>
              <div class="flex flex-1 items-center justify-center py-2">
                <p
                  class="text-2xl font-extrabold text-emerald-700"
                  style="font-family: 'Plus Jakarta Sans', sans-serif"
                >
                  <app-animated-counter
                    [value]="d.today.totalRevenue"
                    [prefix]="'\u20B1'"
                    [prefixColor]="'#6ee7b7'"
                    [decimals]="2"
                    [highlightColor]="'#047857'"
                  />
                </p>
              </div>
              <div class="flex items-center gap-1">
                @if (revenueChangePercent() >= 0) {
                  <app-icon
                    name="icon-arrow-up"
                    [class]="'h-3 w-3 text-emerald-600'"
                    [fill]="'currentColor'"
                  />
                } @else {
                  <app-icon
                    name="icon-arrow-down"
                    [class]="'h-3 w-3 text-red-500'"
                    [fill]="'currentColor'"
                  />
                }
                <span
                  class="text-[10px] font-semibold"
                  [class.text-emerald-600]="revenueChangePercent() >= 0"
                  [class.text-red-500]="revenueChangePercent() < 0"
                >
                  {{ revenueChangePercent() >= 0 ? '+' : '' }}{{ revenueChangePercent() }}%
                  {{ comparisonLabel() }}
                </span>
              </div>
              <div class="mt-1 h-8">
                @if (revenueSparkline().length >= 2) {
                  <app-sparkline
                    [values]="revenueSparkline()"
                    [color]="'#047857'"
                    [id]="'revenue'"
                  />
                }
              </div>
            </div>

            <!-- Order Count -->
            <div class="flex flex-col rounded-2xl bg-white p-4 shadow-md ring-1 ring-black/5">
              <div class="flex items-center gap-2">
                <app-icon name="icon-receipt" [class]="'h-4 w-4 text-blue-500'" />
                <p class="text-xs font-semibold tracking-wider text-gray-500 uppercase">Orders</p>
              </div>
              <div class="flex flex-1 items-center justify-center py-2">
                <p
                  class="text-2xl font-extrabold text-gray-900"
                  style="font-family: 'Plus Jakarta Sans', sans-serif"
                >
                  <app-animated-counter
                    [value]="d.today.totalOrders"
                    [highlightColor]="'#3b82f6'"
                  />
                </p>
              </div>
              <div class="flex items-center gap-1">
                @if (ordersChangePercent() >= 0) {
                  <app-icon
                    name="icon-arrow-up"
                    [class]="'h-3 w-3 text-emerald-600'"
                    [fill]="'currentColor'"
                  />
                } @else {
                  <app-icon
                    name="icon-arrow-down"
                    [class]="'h-3 w-3 text-red-500'"
                    [fill]="'currentColor'"
                  />
                }
                <span
                  class="text-[10px] font-semibold"
                  [class.text-emerald-600]="ordersChangePercent() >= 0"
                  [class.text-red-500]="ordersChangePercent() < 0"
                >
                  {{ ordersChangePercent() >= 0 ? '+' : '' }}{{ ordersChangePercent() }}%
                  {{ comparisonLabel() }}
                </span>
              </div>
              <div class="mt-1 h-8">
                @if (ordersSparkline().length >= 2) {
                  <app-sparkline [values]="ordersSparkline()" [color]="'#3b82f6'" [id]="'orders'" />
                }
              </div>
            </div>

            <!-- Avg. Order Value -->
            <div class="flex flex-col rounded-2xl bg-white p-4 shadow-md ring-1 ring-black/5">
              <div class="flex items-center gap-2">
                <app-icon name="icon-tag" [class]="'h-4 w-4 text-violet-500'" />
                <p class="text-xs font-semibold tracking-wider text-gray-500 uppercase">
                  Avg. Order Value
                </p>
              </div>
              <div class="flex flex-1 items-center justify-center py-2">
                <p
                  class="text-2xl font-extrabold text-gray-900"
                  style="font-family: 'Plus Jakarta Sans', sans-serif"
                >
                  <app-animated-counter
                    [value]="d.today.averageOrderValue"
                    [prefix]="'\u20B1'"
                    [prefixColor]="'#9ca3af'"
                    [decimals]="2"
                    [highlightColor]="'#8b5cf6'"
                  />
                </p>
              </div>
              <div class="flex items-center gap-1">
                @if (avgOrderChangeDelta() >= 0) {
                  <app-icon
                    name="icon-arrow-up"
                    [class]="'h-3 w-3 text-emerald-600'"
                    [fill]="'currentColor'"
                  />
                } @else {
                  <app-icon
                    name="icon-arrow-down"
                    [class]="'h-3 w-3 text-red-500'"
                    [fill]="'currentColor'"
                  />
                }
                <span
                  class="text-[10px] font-semibold"
                  [class.text-emerald-600]="avgOrderChangeDelta() >= 0"
                  [class.text-red-500]="avgOrderChangeDelta() < 0"
                >
                  {{ avgOrderChangeDelta() >= 0 ? '+\u20B1' : '-\u20B1'
                  }}{{
                    (avgOrderChangeDelta() < 0 ? -avgOrderChangeDelta() : avgOrderChangeDelta())
                      | number: '1.2-2'
                  }}
                  {{ comparisonLabel() }}
                </span>
              </div>
              <div class="mt-1 h-8">
                @if (avgOrderSparkline().length >= 2) {
                  <app-sparkline
                    [values]="avgOrderSparkline()"
                    [color]="'#8b5cf6'"
                    [id]="'avgorder'"
                  />
                }
              </div>
            </div>

            <!-- Total Tips -->
            <div class="flex flex-col rounded-2xl bg-white p-4 shadow-md ring-1 ring-black/5">
              <div class="flex items-center gap-2">
                <app-icon name="icon-coins" [class]="'h-4 w-4 text-amber-500'" />
                <p class="text-xs font-semibold tracking-wider text-gray-500 uppercase">Tips</p>
              </div>
              <div class="flex flex-1 items-center justify-center py-2">
                <p
                  class="text-2xl font-extrabold text-gray-900"
                  style="font-family: 'Plus Jakarta Sans', sans-serif"
                >
                  <app-animated-counter
                    [value]="d.today.totalTips"
                    [prefix]="'\u20B1'"
                    [prefixColor]="'#9ca3af'"
                    [decimals]="2"
                    [highlightColor]="'#f59e0b'"
                  />
                </p>
              </div>
              <div class="flex items-center gap-1">
                @if (tipsChangePercent() >= 0) {
                  <app-icon
                    name="icon-arrow-up"
                    [class]="'h-3 w-3 text-emerald-600'"
                    [fill]="'currentColor'"
                  />
                } @else {
                  <app-icon
                    name="icon-arrow-down"
                    [class]="'h-3 w-3 text-red-500'"
                    [fill]="'currentColor'"
                  />
                }
                <span
                  class="text-[10px] font-semibold"
                  [class.text-emerald-600]="tipsChangePercent() >= 0"
                  [class.text-red-500]="tipsChangePercent() < 0"
                >
                  {{ tipsChangePercent() >= 0 ? '+' : '' }}{{ tipsChangePercent() }}%
                  {{ comparisonLabel() }}
                </span>
              </div>
              <div class="mt-1 h-8">
                @if (tipsSparkline().length >= 2) {
                  <app-sparkline [values]="tipsSparkline()" [color]="'#f59e0b'" [id]="'tips'" />
                }
              </div>
            </div>
          </div>

          <!-- Operation Status - segmented progress bar -->
          <div class="rounded-2xl bg-white p-4 shadow-md ring-1 ring-black/5">
            <h2 class="mb-3 text-xs font-semibold tracking-wider text-gray-500 uppercase">
              Operation Status
            </h2>

            <!-- Segmented bar -->
            @if (statusTotal() > 0) {
              <div class="flex h-3 w-full overflow-hidden rounded-full bg-gray-100">
                @if (d.ordersByStatus.completed > 0) {
                  <div
                    class="bg-emerald-500 transition-all duration-500"
                    [style.width.%]="statusPercent(d.ordersByStatus.completed)"
                  ></div>
                }
                @if (d.ordersByStatus.pending > 0) {
                  <div
                    class="bg-orange-400 transition-all duration-500"
                    [style.width.%]="statusPercent(d.ordersByStatus.pending)"
                  ></div>
                }
                @if (d.ordersByStatus.cancelled > 0) {
                  <div
                    class="bg-gray-400 transition-all duration-500"
                    [style.width.%]="statusPercent(d.ordersByStatus.cancelled)"
                  ></div>
                }
                @if (d.ordersByStatus.refunded > 0) {
                  <div
                    class="bg-red-400 transition-all duration-500"
                    [style.width.%]="statusPercent(d.ordersByStatus.refunded)"
                  ></div>
                }
              </div>
            } @else {
              <div class="flex h-3 w-full overflow-hidden rounded-full bg-gray-100"></div>
            }

            <!-- 2x2 status grid -->
            <div class="mt-3 grid grid-cols-2 gap-2">
              <div
                class="flex items-center justify-center gap-1.5 rounded-xl border border-emerald-100 bg-emerald-50/60 px-3 py-2"
              >
                <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                <span class="text-[10px] font-semibold tracking-wider text-emerald-700 uppercase"
                  >Completed</span
                >
                <span class="text-sm font-bold text-emerald-800">{{
                  d.ordersByStatus.completed
                }}</span>
              </div>
              <div
                class="flex items-center justify-center gap-1.5 rounded-xl border border-orange-100 bg-orange-50/60 px-3 py-2"
              >
                <span class="h-2 w-2 rounded-full bg-orange-400"></span>
                <span class="text-[10px] font-semibold tracking-wider text-orange-700 uppercase"
                  >Pending</span
                >
                <span class="text-sm font-bold text-orange-800">{{
                  d.ordersByStatus.pending
                }}</span>
              </div>
              <div
                class="flex items-center justify-center gap-1.5 rounded-xl border border-gray-200 bg-gray-50/60 px-3 py-2"
              >
                <span class="h-2 w-2 rounded-full bg-gray-400"></span>
                <span class="text-[10px] font-semibold tracking-wider text-gray-600 uppercase"
                  >Cancelled</span
                >
                <span class="text-sm font-bold text-gray-800">{{
                  d.ordersByStatus.cancelled
                }}</span>
              </div>
              <div
                class="flex items-center justify-center gap-1.5 rounded-xl border border-red-100 bg-red-50/60 px-3 py-2"
              >
                <span class="h-2 w-2 rounded-full bg-red-400"></span>
                <span class="text-[10px] font-semibold tracking-wider text-red-600 uppercase"
                  >Refunded</span
                >
                <span class="text-sm font-bold text-red-800">{{ d.ordersByStatus.refunded }}</span>
              </div>
            </div>
          </div>
          <!-- 2. Sales + Orders Trend -->
          <div class="grid grid-cols-1 gap-2 md:grid-cols-2 md:gap-3">
            <!-- Sales by Hour -->
            <div
              class="rounded-2xl bg-white px-4 py-3 shadow-md ring-1 ring-black/5 md:px-5 md:py-4"
            >
              <h2 class="mb-3 text-xs font-semibold tracking-wider text-gray-500 uppercase">
                {{ chartTitle() }}
              </h2>
              @if (salesByHour().length === 0) {
                <div class="flex h-36 items-center justify-center">
                  <p class="text-sm text-gray-400">No sales data yet</p>
                </div>
              } @else {
                <div class="h-44">
                  <app-area-chart [data]="salesByHour()" [color]="'#047857'" />
                </div>
              }
            </div>

            <!-- Orders by Period -->
            <div
              class="rounded-2xl bg-white px-4 py-3 shadow-md ring-1 ring-black/5 md:px-5 md:py-4"
            >
              <h2 class="mb-3 text-xs font-semibold tracking-wider text-gray-500 uppercase">
                {{ isMultiDay() ? 'Orders by Day' : 'Orders by Hour' }}
              </h2>
              @if (ordersByPeriod().length === 0) {
                <div class="flex h-36 items-center justify-center">
                  <p class="text-sm text-gray-400">No order volume data yet</p>
                </div>
              } @else {
                <div class="h-44">
                  <app-area-chart [data]="ordersByPeriod()" [color]="'#3b82f6'" />
                </div>
              }
            </div>
          </div>

          <!-- 3. Top Selling Products -->
          <div class="rounded-2xl bg-white px-4 py-3 shadow-md ring-1 ring-black/5 md:px-5 md:py-4">
            <h2 class="mb-3 text-xs font-semibold tracking-wider text-gray-500 uppercase">
              Top Selling Products
            </h2>
            @if (d.topSellingProducts.length === 0) {
              <div class="rounded-lg p-6 text-center">
                <app-icon name="icon-cart" [class]="'mx-auto mb-2 h-10 w-10 text-gray-300'" />
                <p class="text-sm text-gray-500">No completed orders yet</p>
              </div>
            } @else {
              <div class="space-y-3">
                @for (product of d.topSellingProducts; track product.productId) {
                  <div class="flex items-center gap-3">
                    <!-- Circular thumbnail -->
                    <div
                      class="flex h-10 w-10 shrink-0 items-center justify-center overflow-hidden rounded-full bg-gray-50 ring-2 ring-gray-200"
                    >
                      <app-avatar
                        [label]="product.productName"
                        [size]="40"
                        [imageUrl]="product.imageUrl ?? null"
                      />
                    </div>

                    <div class="min-w-0 flex-1">
                      <div class="flex items-center justify-between">
                        <p class="truncate text-sm font-medium text-gray-900">
                          {{ product.productName }}
                        </p>
                        <p class="shrink-0 text-xs font-semibold text-emerald-700">
                          Rev {{ productRevenuePercent(product.revenue) }}%
                        </p>
                      </div>
                      <div class="mt-0.5 flex items-center gap-2">
                        <span class="shrink-0 text-xs text-gray-500"
                          >{{ product.quantitySold }} sold</span
                        >
                        <div class="h-1.5 flex-1 overflow-hidden rounded-full bg-gray-100">
                          <div
                            class="h-full rounded-full bg-emerald-500 transition-all duration-500"
                            [style.width.%]="productRevenuePercent(product.revenue)"
                          ></div>
                        </div>
                        <span class="shrink-0 text-[10px] font-medium text-gray-400">
                          <span class="text-[9px]"><app-icon name="icon-peso" [class]="'inline h-3 w-3 align-[-0.125em]'" [fill]="'currentColor'" /></span
                          >{{ product.revenue | number: '1.2-2' }}
                        </span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- 4. Payment Methods + Recent Activity -->
          <div class="grid grid-cols-1 gap-2 md:grid-cols-5 md:gap-3">
            <!-- Payment Methods (40%) -->
            <div
              class="rounded-2xl bg-white px-4 py-3 shadow-md ring-1 ring-black/5 md:col-span-2 md:px-5 md:py-4"
            >
              <h2 class="mb-3 text-xs font-semibold tracking-wider text-gray-500 uppercase">
                Payment Methods
              </h2>
              @if (paymentDonutSegments().length === 0) {
                <div class="rounded-lg p-6 text-center">
                  <app-icon name="icon-cart" [class]="'mx-auto mb-2 h-10 w-10 text-gray-300'" />
                  <p class="text-sm text-gray-400">No payment data yet</p>
                </div>
              } @else {
                <div class="flex items-center justify-center py-2">
                  <app-donut-chart [segments]="paymentDonutSegments()" />
                </div>
              }
            </div>

            <!-- Recent Activity (60%) -->
            <div
              class="rounded-2xl bg-white px-4 py-3 shadow-md ring-1 ring-black/5 md:col-span-3 md:px-5 md:py-4"
            >
              <div class="mb-3 flex items-center justify-between">
                <h2 class="text-xs font-semibold tracking-wider text-gray-500 uppercase">
                  Recent Activity
                </h2>
                <a
                  routerLink="/orders/list"
                  class="text-xs font-medium text-emerald-700 hover:underline"
                >
                  View All
                </a>
              </div>

              @if (d.recentOrders.length === 0) {
                <div class="rounded-lg p-6 text-center">
                  <app-icon name="icon-cart" [class]="'mx-auto mb-2 h-10 w-10 text-gray-300'" />
                  <p class="text-sm text-gray-500">No orders yet</p>
                </div>
              } @else {
                <div class="divide-y divide-gray-100">
                  @for (order of d.recentOrders; track order.id) {
                    <div class="grid grid-cols-[auto_auto_1fr_auto] items-center gap-x-3 py-2.5">
                      <span class="text-sm font-semibold text-gray-900"
                        >#{{ order.orderNumber }}</span
                      >
                      <app-badge [variant]="getStatusVariant(order.statusId)">
                        {{ order.statusName }}
                      </app-badge>
                      <span class="text-right text-sm font-semibold text-gray-900">
                        <span class="text-xs font-medium text-gray-400"><app-icon name="icon-peso" [class]="'inline h-3 w-3 align-[-0.125em]'" [fill]="'currentColor'" /></span
                        >{{ order.totalAmount | number: '1.2-2' }}
                      </span>
                      <span class="w-14 text-right text-xs text-slate-400">{{
                        orderTimeAgos()[order.id]
                      }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }
    </app-pull-to-refresh>
  }
</div>

